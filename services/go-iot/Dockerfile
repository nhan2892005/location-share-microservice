FROM golang:1.21-alpine AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download

# Install build dependencies for CGO
RUN apk add --no-cache build-base pkgconf

COPY . .
# Enable CGO, add musl tag for Alpine, remove -installsuffix cgo (not needed here)
RUN CGO_ENABLED=1 GOOS=linux go build -tags musl -a -o main .

FROM alpine:latest
RUN apk --no-cache add ca-certificates curl
WORKDIR /root/
COPY --from=builder /app/main .

EXPOSE 8081

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8081/health || exit 1

CMD ["./main"]